#!/usr/bin/env ruby
# frozen_string_literal: true

require 'yaml'
require 'json'
require 'erb'
require 'fileutils'

# Generate a stats dashboard HTML page showing YJIT stats for all benchmarks
class StatsDashboardGenerator
  def initialize
    @rubies = load_rubies
    @benchmarks = load_benchmark_list
    @stats_data = {}
    @exit_reports = {}
  end

  def generate
    load_stats_data
    find_exit_reports

    html = generate_html
    output_path = 'results/yjit_stats.html'

    File.write(output_path, html)
    puts "Generated stats dashboard: #{output_path}"

    # Also generate a summary YAML for the main dashboard
    generate_summary_yaml
  end

  private

  def load_rubies
    path = 'results/rubies.yml'
    return {} unless File.exist?(path)
    YAML.load_file(path)
  end

  def load_benchmark_list
    benchmarks_file = 'benchmark/ruby-bench/benchmarks.yml'
    return [] unless File.exist?(benchmarks_file)
    YAML.load_file(benchmarks_file).keys.sort
  end

  def load_stats_data
    # Load YJIT stats for each benchmark
    @benchmarks.each do |benchmark|
      yjit_stats_file = "results/yjit-stats/#{benchmark}.yml"
      if File.exist?(yjit_stats_file)
        @stats_data[benchmark] = YAML.load_file(yjit_stats_file)
      end
    end
  end

  def find_exit_reports
    # Find the latest exit reports for each benchmark
    Dir.glob('results/exit-reports/*').each do |date_dir|
      date = File.basename(date_dir)
      Dir.glob("#{date_dir}/*.txt").each do |report_file|
        filename = File.basename(report_file)
        if match = filename.match(/^(.+)_yjit\.txt$/)
          benchmark = match[1]
          # Keep only the latest report for each benchmark
          if !@exit_reports[benchmark] || date > @exit_reports[benchmark][:date]
            @exit_reports[benchmark] = {
              date: date,
              path: report_file.sub(/^results\//, '')
            }
          end
        end
      end
    end
  end

  def generate_html
    template = <<~HTML
      <!DOCTYPE html>
      <html>
      <head>
        <title>YJIT Stats Dashboard</title>
        <style>
          body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
          }
          h1 {
            color: #333;
            border-bottom: 2px solid #e1e4e8;
            padding-bottom: 10px;
          }
          .stats-table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 20px;
          }
          .stats-table th {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
          }
          .stats-table td {
            border: 1px solid #e1e4e8;
            padding: 6px 12px;
            font-size: 13px;
          }
          .stats-table tr:hover {
            background: #f6f8fa;
          }
          .ratio-high { color: #28a745; font-weight: bold; }
          .ratio-medium { color: #856404; }
          .ratio-low { color: #dc3545; }
          .number { text-align: right; font-family: monospace; }
          .exit-link { color: #0366d6; text-decoration: none; }
          .exit-link:hover { text-decoration: underline; }
          .na { color: #999; font-style: italic; }
          .updated {
            color: #666;
            font-size: 12px;
            margin-top: 20px;
          }
          .legend {
            margin: 20px 0;
            padding: 10px;
            background: #fff;
            border: 1px solid #e1e4e8;
            font-size: 13px;
          }
        </style>
      </head>
      <body>
        <h1>YJIT Statistics Dashboard</h1>

        <div class="legend">
          <strong>Metrics:</strong>
          <ul>
            <li><strong>Ratio in YJIT:</strong> Percentage of instructions executed by YJIT (higher is better)</li>
            <li><strong>Inline/Outlined:</strong> Code size generated by YJIT compiler</li>
            <li><strong>Compiled:</strong> Number of methods (iSeqs) and blocks compiled</li>
            <li><strong>Inval %:</strong> Percentage of compiled blocks that were invalidated (lower is better)</li>
            <li><strong>Compile Time:</strong> Time spent in JIT compilation</li>
          </ul>
        </div>

        <table class="stats-table">
          <thead>
            <tr>
              <th>Benchmark</th>
              <th>Exit Report</th>
              <th>Ratio in YJIT</th>
              <th>Avg Len</th>
              <th>Inline (KB)</th>
              <th>Outlined (KB)</th>
              <th>Compiled iSeqs</th>
              <th>Compiled Blocks</th>
              <th>Inval %</th>
              <th>Compile Time (ms)</th>
            </tr>
          </thead>
          <tbody>
            <%= generate_table_rows %>
          </tbody>
        </table>

        <div class="updated">
          Generated: <%= Time.now.strftime('%Y-%m-%d %H:%M:%S %Z') %>
        </div>
      </body>
      </html>
    HTML

    ERB.new(template).result(binding)
  end

  def generate_table_rows
    rows = []

    # Get the latest date for which we have stats
    latest_dates = {}
    @stats_data.each do |benchmark, dates_data|
      latest_dates[benchmark] = dates_data.keys.max if dates_data && !dates_data.empty?
    end

    @benchmarks.each do |benchmark|
      date = latest_dates[benchmark]

      if date && @stats_data[benchmark] && @stats_data[benchmark][date]
        stats = @stats_data[benchmark][date]

        # Format ratio_in_yjit with color coding
        ratio = stats['ratio_in_yjit']
        ratio_class = if ratio >= 99.0
          'ratio-high'
        elsif ratio >= 95.0
          'ratio-medium'
        else
          'ratio-low'
        end

        # Exit report link
        exit_link = if @exit_reports[benchmark]
          "<a href='#{@exit_reports[benchmark][:path]}' class='exit-link'>View</a>"
        else
          "<span class='na'>N/A</span>"
        end

        rows << <<~ROW
          <tr>
            <td><strong>#{benchmark}</strong></td>
            <td>#{exit_link}</td>
            <td class="number #{ratio_class}">#{'%.2f' % ratio}%</td>
            <td class="number">#{'%.1f' % stats['avg_len_in_yjit']}</td>
            <td class="number">#{(stats['inline_code_size'] / 1024.0).round(1)}</td>
            <td class="number">#{(stats['outlined_code_size'] / 1024.0).round(1)}</td>
            <td class="number">#{stats['compiled_iseq_count']}</td>
            <td class="number">#{stats['compiled_block_count']}</td>
            <td class="number">#{'%.1f' % stats['invalidation_ratio']}%</td>
            <td class="number">#{'%.1f' % stats['compile_time_ms']}</td>
          </tr>
        ROW
      else
        rows << <<~ROW
          <tr>
            <td><strong>#{benchmark}</strong></td>
            <td colspan="9" class="na">No stats available</td>
          </tr>
        ROW
      end
    end

    rows.join("\n")
  end

  def generate_summary_yaml
    summary = {
      'stats_summary' => {
        'latest_date' => @rubies.keys.max,
        'benchmarks_with_stats' => @stats_data.keys.count,
        'avg_ratio_in_yjit' => {},
        'exit_reports_available' => !@exit_reports.empty?
      }
    }

    # Calculate average ratio_in_yjit by category
    categories = {
      'headline' => %w[activerecord hexapdf liquid-render psych-load railsbench],
      'other' => [],
      'micro' => []
    }

    # Categorize benchmarks
    @stats_data.keys.each do |benchmark|
      if categories['headline'].include?(benchmark)
        # Already in headline
      elsif benchmark.include?('micro') || benchmark.start_with?('30k_')
        categories['micro'] << benchmark
      else
        categories['other'] << benchmark
      end
    end

    # Calculate averages
    categories.each do |category, benchmarks|
      next if benchmarks.empty?

      ratios = []
      benchmarks.each do |benchmark|
        if @stats_data[benchmark]
          latest_date = @stats_data[benchmark].keys.max
          if latest_date && @stats_data[benchmark][latest_date]
            ratios << @stats_data[benchmark][latest_date]['ratio_in_yjit']
          end
        end
      end

      if ratios.any?
        summary['stats_summary']['avg_ratio_in_yjit'][category] = (ratios.sum / ratios.size).round(2)
      end
    end

    # Append to dashboard.yml if it exists
    dashboard_file = 'results/dashboard.yml'
    if File.exist?(dashboard_file)
      dashboard = YAML.load_file(dashboard_file)
      dashboard.merge!(summary)
      File.write(dashboard_file, dashboard.to_yaml)
      puts "Updated dashboard.yml with stats summary"
    else
      # Create a standalone summary file
      File.write('results/stats_summary.yml', summary.to_yaml)
      puts "Created stats_summary.yml"
    end
  end
end

# Run the generator
if __FILE__ == $0
  generator = StatsDashboardGenerator.new
  generator.generate
end